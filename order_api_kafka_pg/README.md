
# Orders API (Flask) + PostgreSQL + Kafka (Redpanda) demo

This is a minimal, production-ish example:
- `POST /orders` stores an order into **Postgres** and produces a JSON message to Kafka topic **`orders_created`**.
- `consumer.py` listens to **`orders_created`** and logs messages.
- Uses **kafka-python-ng** client and **Flask**.
- Includes **Docker Compose** for local Postgres and **Redpanda** (Kafka compatible).

## Quick start (local with Docker Compose)

1) Start dependencies:
```bash
docker compose up -d
# Postgres on localhost:5432 (user: app, pass: app, db: app)
# Redpanda broker on localhost:9092
```

2) Create and activate virtualenv, install deps:
```bash
python -m venv .venv && source .venv/bin/activate   # Windows: .venv\Scripts\Activate.ps1
pip install -r requirements.txt
cp .env.sample .env
```

3) Run the API:
```bash
python app.py
# Flask will listen on 0.0.0.0:8000 by default
```

4) Create an order:
```bash
curl -s -X POST http://localhost:8000/orders   -H "Content-Type: application/json"   -d '{"name":"Jiten","item":"Laptop","price":99999.50,"quantity":2}' | jq
```

Expected response (example):
```json
{
  "ok": true,
  "order": {
    "id": "9a5d8b3a-...",
    "name": "Jiten",
    "item": "Laptop",
    "price": 99999.5,
    "quantity": 2
  }
}
```

5) Run the consumer (separate terminal):
```bash
python consumer.py
```

You should see messages coming from the topic `orders_created`.

---

## Environment

Copy `.env.sample` to `.env` and adjust as needed.

- **Postgres** connection settings (`PGHOST`, `PGPORT`, `PGUSER`, `PGPASSWORD`, `PGDATABASE`)
- **Kafka/Redpanda** broker (`KAFKA_BOOTSTRAP=localhost:9092`)
- API port (`PORT=8000`)

---

## Notes

- The API **auto-creates** the `orders` table if it doesn't exist.
- `id` is a UUID generated by the API.
- Price is stored as `NUMERIC(12,2)`; we coerce to two decimals before insert.
- Message key is the order `id`; payload is the full order JSON.
- For real deployments, add: retries/compaction policies, idempotent producers, DLQs, logging/metrics & tracing, etc.
